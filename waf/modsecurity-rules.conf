# ModSecurity WAF Rules for FineAcers

SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# SQL Injection Prevention
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|XML://* "(?i)(union.*select|select.*from|insert.*into|delete.*from|update.*set|drop.*table|exec.*\(|execute.*\(|script.*>|<.*iframe|into.*outfile|load_file)" \
    "id:1001,\
    phase:2,\
    block,\
    msg:'SQL Injection Attack Detected',\
    severity:'CRITICAL',\
    tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"

# XSS Prevention
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|XML://* "(?i)(<script[^>]*>|javascript:|onerror=|onload=|onclick=|onmouseover=|<iframe|<object|<embed|<meta|eval\(|alert\(|confirm\(|prompt\()" \
    "id:1002,\
    phase:2,\
    block,\
    msg:'Cross-Site Scripting Attack Detected',\
    severity:'CRITICAL',\
    tag:'OWASP_CRS/WEB_ATTACK/XSS',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"

# Command Injection Prevention
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "(?i)(;|\||`|>|<|\$\(|\${|&&|\|\|)" \
    "id:1003,\
    phase:2,\
    block,\
    msg:'OS Command Injection Attack Detected',\
    severity:'CRITICAL',\
    tag:'OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION'"

# Directory Traversal Prevention
SecRule REQUEST_URI|ARGS "(?i)(\.\.\/|\.\.\\|%2e%2e%2f|%2e%2e%5c|%252e%252e%252f)" \
    "id:1004,\
    phase:2,\
    block,\
    msg:'Directory Traversal Attack Detected',\
    severity:'HIGH',\
    tag:'OWASP_CRS/WEB_ATTACK/DIR_TRAVERSAL'"

# File Upload Security
SecRule FILES_TMPNAMES "@rx .*" \
    "id:1005,\
    phase:2,\
    t:none,\
    block,\
    msg:'File Upload Attack Detected',\
    severity:'HIGH',\
    chain"
    SecRule FILES "@rx (?i)\.(php|phtml|php3|php4|php5|phps|asp|aspx|jsp|asa|cer|cdx|sh|bat|exe|scr|dll|com|cgi|pl)$" \
        "setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}'"

# API Rate Limiting Headers
SecRule REQUEST_HEADERS:X-Forwarded-For "@rx ^$" \
    "id:1006,\
    phase:1,\
    pass,\
    nolog,\
    setvar:'tx.real_ip=%{REMOTE_ADDR}'"

SecRule REQUEST_HEADERS:X-Forwarded-For "@rx ^(.*)$" \
    "id:1007,\
    phase:1,\
    pass,\
    nolog,\
    capture,\
    setvar:'tx.real_ip=%{TX.1}'"

# Rate Limiting Rules
SecAction \
    "id:1008,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{tx.real_ip},\
    setvar:ip.requests=+1,\
    expirevar:ip.requests=60"

SecRule IP:requests "@gt 100" \
    "id:1009,\
    phase:2,\
    block,\
    msg:'Rate Limit Exceeded',\
    severity:'WARNING',\
    tag:'RATE_LIMIT'"

# CSRF Protection
SecRule REQUEST_METHOD "^(POST|PUT|DELETE)$" \
    "id:1010,\
    phase:2,\
    block,\
    msg:'CSRF Token Missing',\
    severity:'HIGH',\
    tag:'CSRF',\
    chain"
    SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0"

# JSON Content Validation
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:1011,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyProcessor=JSON"

SecRule REQBODY_ERROR "!@eq 0" \
    "id:1012,\
    phase:2,\
    block,\
    msg:'Invalid JSON in Request Body',\
    severity:'WARNING',\
    tag:'INVALID_JSON'"

# Whitelist IP Addresses
SecRule REMOTE_ADDR "@ipMatch 192.168.1.0/24,10.0.0.0/8" \
    "id:1013,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Custom Headers Validation
SecRule REQUEST_HEADERS:User-Agent "^$" \
    "id:1014,\
    phase:1,\
    block,\
    msg:'Missing User-Agent Header',\
    severity:'NOTICE'"

# Anomaly Scoring
SecRule TX:ANOMALY_SCORE "@ge 5" \
    "id:1099,\
    phase:2,\
    block,\
    msg:'Anomaly Score Exceeded',\
    severity:'CRITICAL',\
    tag:'ANOMALY',\
    logdata:'Anomaly Score: %{TX.ANOMALY_SCORE}'"